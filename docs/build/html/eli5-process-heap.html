<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Process Heaps ELI5 &#8212; BEAM VM Wisdoms</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Input/Output and Ports ELI5" href="eli5-io.html" />
    <link rel="prev" title="Processes ELI5" href="eli5-processes.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
<section id="process-heaps-eli5">
<h1>Process Heaps ELI5<a class="headerlink" href="#process-heaps-eli5" title="Permalink to this heading">¶</a></h1>
<p>Everything in Erlang is a <a class="reference internal" href="definitions.html#def-term"><span class="std std-ref">Term</span></a>.</p>
<p>A heap of the process is an array of <a class="reference internal" href="definitions.html#def-term"><span class="std std-ref">Terms</span></a>. A stack is
another array of <a class="reference internal" href="definitions.html#def-term"><span class="std std-ref">Terms</span></a>. Stack is located inside the heap.
<a class="reference internal" href="definitions.html#def-registers"><span class="std std-ref">Registers</span></a> — are array of <a class="reference internal" href="definitions.html#def-term"><span class="std std-ref">Terms</span></a> too!
Things on the heap are mostly arrays of <a class="reference internal" href="definitions.html#def-term"><span class="std std-ref">Terms</span></a>, but tagged
with <a class="reference internal" href="definitions.html#def-header"><span class="std std-ref">header tag</span></a> (see <a class="reference internal" href="indepth-memory-layout.html"><span class="doc">Data Types Memory Layout</span></a>).</p>
<section id="heap-carriers">
<h2>Heap Carriers<a class="headerlink" href="#heap-carriers" title="Permalink to this heading">¶</a></h2>
<p>Allocation in Erlang happens inside so called “carriers”. They look like
“zone memory”, used by games — big chunks of system heap pre-allocated
beforehand. Inside carriers the real allocation is happening. For simplicity
you can imagine simple malloc/realloc, that’s how its done.</p>
<p>This complication is done to fight memory fragmentation and is not important
for the understanding.
You can see <code class="docutils literal notranslate"><span class="pre">erts/emulator/beam/erl_*alloc.c</span></code> (many those files, one per
strategy of allocation). Emulator has command line flags, which control
allocation strategies (see <a class="reference external" href="http://erlang.org/doc/man/erts_alloc.html">http://erlang.org/doc/man/erts_alloc.html</a> flags
section).</p>
</section>
<section id="allocating-inside-heap">
<h2>Allocating Inside Heap<a class="headerlink" href="#allocating-inside-heap" title="Permalink to this heading">¶</a></h2>
<p>When a process needs some memory, its <code class="docutils literal notranslate"><span class="pre">heap_top</span></code> is incremented and memory
under it is ready to use. Some activities may want to allocate on other
process’ heaps, for example sending a message will perform a copy to the
receiving process.</p>
<p>No bookkeeping is happening inside a process heap.
There is no tracking which word belongs where, but it is possible to know
what is stored in each memory cell by looking at the tag bits.</p>
</section>
<section id="garbage-collection">
<h2>Garbage Collection<a class="headerlink" href="#garbage-collection" title="Permalink to this heading">¶</a></h2>
<p>Garbage collector traces known live values from registers and stack and saves
them, then drops everything else.</p>
<p>When a heap comes to its capacity threshold (something like 75%), the process
triggers garbage collection. A new bigger heap may be allocated.
Scanning generational garbage collection algorithm runs on the heap.
The algorithm takes the “<a class="reference internal" href="definitions.html#def-roots"><span class="std std-ref">roots</span></a>” and moves them to the
new heap.
Then it scans the remaining parts of source heap
and extracts more values, referred by the roots. After the scanning, source
heap contains only dead values and algorithm drops it.</p>
<p>“Scanning” means, that garbage collector follows the data
<a class="reference internal" href="definitions.html#def-roots"><span class="std std-ref">roots</span></a> from the start to the end, parsing everything it meets.
“Generational” means, that algorithm splits data into young and old generation,
assuming that data often dies young, and old data is less likely to be freed.
Also the algorithm remembers the old position (<code class="docutils literal notranslate"><span class="pre">mature</span></code>), where the previous
scanning has finished.
Any data below it is guaranteed to have not updated since the last scan.
This trick reduces amount of scanning and speeds up the algorithm.</p>
<p>In reality the picture is a bit more complicated. There can be one or two
heaps with different placement logic applied to them.</p>
<p>Having garbage collector run per process heap allows Erlang to keep
collection latency low. Also it doesn’t pause or affect other processes on
other schedulers. This is not a simple topic, but theory is all here:
<a class="reference external" href="http://gchandbook.org/">http://gchandbook.org/</a></p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>BEAM Wisdoms: In depth: <a class="reference internal" href="indepth-heap-layout.html"><span class="doc">Process Heap Layout</span></a>.</p>
<p>BEAM Wisdoms: In depth: <a class="reference internal" href="indepth-memory-layout.html"><span class="doc">Data Types Memory Layout</span></a>.</p>
<p><a class="reference external" href="https://www.erlang-solutions.com/blog/erlang-19-0-garbage-collector.html">Garbage Collector in Erlang 19</a></p>
</div>
</section>
</section>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-84125230-1', 'auto');
ga('send', 'pageview');
</script>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div style="margin-bottom:16px;">
    <a href="http://beam-wisdoms.clau.se/" alt="Wisdoms Home Page"
    title="Return to the Home Page"><img src="_static/img/bw_logo.png" width="200"></a>
</div>


<h1 class="logo"><a href="index.html">BEAM VM Wisdoms</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="eli5-vm.html">BEAM VM ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-atoms.html">Atoms ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-processes.html">Processes ELI5</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Process Heaps ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-io.html">Input/Output and Ports ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-tracing.html">Tracing ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-bif-nif.html">BIF and NIF functions ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-types.html">Types ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-etf.html">External Term Format ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-property-based.html">Property Based Testing ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-efficiency.html">Efficiency ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-efficiency-memory-perf.html">Memory Performance ELI5</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="definitions.html">BEAM Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-memory-layout.html">Data Types Memory Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-data-sizes.html">BEAM Internal data sizes</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-heap-layout.html">Process Heap Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="interfacing.html">Interfacing Erlang with the Outer World</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-beam-file.html">BEAM File Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-beam-instructions.html">BEAM Instruction Codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-io.html">IO in Erlang</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="eli5-processes.html" title="previous chapter">Processes ELI5</a></li>
      <li>Next: <a href="eli5-io.html" title="next chapter">Input/Output and Ports ELI5</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016-2023, Dmytro "kvakvs" Lytovchenko.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/eli5-process-heap.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>