<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Process Heap Layout &#8212; BEAM VM Wisdoms</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Interfacing Erlang with the Outer World" href="interfacing.html" />
    <link rel="prev" title="BEAM Internal data sizes" href="indepth-data-sizes.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
<section id="process-heap-layout">
<h1>Process Heap Layout<a class="headerlink" href="#process-heap-layout" title="Permalink to this heading">¶</a></h1>
<p>An Erlang process has a young heap (where all new data is placed), old heap
(possibly this one does not exist, contains data which survived previous garbage
collection) and a stack, which is located inside young heap.</p>
<p>Also a process has access to read-only literal area, which belongs to one or more
of Erlang modules, it contains constant literals which are found in module code.
At some rare occasions (code upgrade or purge) literal area can be copied to
old heap by means of garbage-collection (see <code class="docutils literal notranslate"><span class="pre">erts_garbage_collect_literals</span></code>
in <code class="docutils literal notranslate"><span class="pre">erl_gc.c</span></code>).</p>
<p>A process has chain of Off-heap objects (so-called MSO – mark and sweep object
list). The head of the chain is a field in <code class="docutils literal notranslate"><span class="pre">Process</span></code> struct, and the chain
continues through the heap visiting <a class="reference internal" href="definitions.html#def-header"><span class="std std-ref">Header</span></a> objects such as
refc binaries and fun closures. During garbage collection this chain is followed
and actions can be taken (similar to C++ destructors) when an MSO object is going
to die – for example refc binaries have their refcount reduced and possibly
are freed. MSO objects are strictly sorted from new to old, by the order of their
creation on heap.</p>
<section id="how-heap-grows">
<h2>How Heap Grows<a class="headerlink" href="#how-heap-grows" title="Permalink to this heading">¶</a></h2>
<p>Additionally heap segments can exist (for situations, when heap is not enough,
but data must be allocated). Heap segments are consolidated before garbage
collection and merged onto heap.</p>
<p>Heap top (<code class="docutils literal notranslate"><span class="pre">heap_top</span></code>) marks current allocation position in heap. When more data
is needed, <code class="docutils literal notranslate"><span class="pre">heap_top</span></code> is advanced forward and data goes there.</p>
<p>Heap always grows forward from <code class="docutils literal notranslate"><span class="pre">heap_start</span></code> (see <code class="docutils literal notranslate"><span class="pre">erl_process.h</span></code>, <code class="docutils literal notranslate"><span class="pre">Process</span></code>
struct, fields <code class="docutils literal notranslate"><span class="pre">heap</span></code>, <code class="docutils literal notranslate"><span class="pre">old_heap</span></code>). Stack always grows backwards from
<code class="docutils literal notranslate"><span class="pre">heap_end</span></code> to <code class="docutils literal notranslate"><span class="pre">heap_top</span></code>, as soon as stack meets heap top, the young heap
is considered full and garbage collection is triggered.</p>
<p>Old heap does not contain a stack. Old heap can only grow during garbage
collection and its future size is precalculated.</p>
<p>To minimize memory fragmentation, heap sizes like a puzzle pieces are allocated
following Fibonacci sequence (starting from 12 and 38 <a class="reference internal" href="definitions.html#def-word"><span class="std std-ref">Words</span></a>)
for 23 total steps, after which (at about 1.3 million <a class="reference internal" href="definitions.html#def-word"><span class="std std-ref">Words</span></a>)
sequence continues by adding 20% to the previous value.</p>
</section>
</section>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-84125230-1', 'auto');
ga('send', 'pageview');
</script>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div style="margin-bottom:16px;">
    <a href="http://beam-wisdoms.clau.se/" alt="Wisdoms Home Page"
    title="Return to the Home Page"><img src="_static/img/bw_logo.png" width="200"></a>
</div>


<h1 class="logo"><a href="index.html">BEAM VM Wisdoms</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="eli5-vm.html">BEAM VM ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-atoms.html">Atoms ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-processes.html">Processes ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-process-heap.html">Process Heaps ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-io.html">Input/Output and Ports ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-tracing.html">Tracing ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-bif-nif.html">BIF and NIF functions ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-types.html">Types ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-etf.html">External Term Format ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-property-based.html">Property Based Testing ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-efficiency.html">Efficiency ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-efficiency-memory-perf.html">Memory Performance ELI5</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="definitions.html">BEAM Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-memory-layout.html">Data Types Memory Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-data-sizes.html">BEAM Internal data sizes</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Process Heap Layout</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#how-heap-grows">How Heap Grows</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="interfacing.html">Interfacing Erlang with the Outer World</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-beam-file.html">BEAM File Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-beam-instructions.html">BEAM Instruction Codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-io.html">IO in Erlang</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="indepth-data-sizes.html" title="previous chapter">BEAM Internal data sizes</a></li>
      <li>Next: <a href="interfacing.html" title="next chapter">Interfacing Erlang with the Outer World</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016-2017, Dmytro "kvakvs" Lytovchenko.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/indepth-heap-layout.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>