<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>BEAM VM ELI5 &#8212; BEAM VM Wisdoms</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Atoms ELI5" href="eli5-atoms.html" />
    <link rel="prev" title="Welcome, adventurer!" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
<section id="beam-vm-eli5">
<h1>BEAM VM ELI5<a class="headerlink" href="#beam-vm-eli5" title="Permalink to this heading">¶</a></h1>
<p>BEAM got its name from Bogdan/Björn Erlang Abstract machine. This is register
VM, but it also has a stack.</p>
<section id="registers-and-calls">
<h2>Registers and Calls<a class="headerlink" href="#registers-and-calls" title="Permalink to this heading">¶</a></h2>
<p>Being a register VM means that stack is not used to pass arguments
between calls, but registers are. They are not same registers as one would
expect to see in a CPU architecture, but rather just an array of
<a class="reference internal" href="definitions.html#def-term"><span class="std std-ref">Term</span></a> values. There are 1024 registers but functions of such
arity are rare, so usually VM only uses first 3 to 10 registers.</p>
<p>For example, when a call to a function of arity 3 is made: registers x0, x1,
and x2 are set to function arguments. If we ever need to make a recursive
call, we will have to overwrite registers and lose the original values in
them. In this situation, we will need to save old values on the stack. There
is no dynamic stack allocation other than stack frame, determined by the
compiler.</p>
<p>Each process has own set of registers.</p>
</section>
<section id="instructions">
<h2>Instructions<a class="headerlink" href="#instructions" title="Permalink to this heading">¶</a></h2>
<p>BEAM instruction set contains approximately 158 basic instructions, most of them
can be visible if you dump assembly by calling <code class="docutils literal notranslate"><span class="pre">erlc</span> <span class="pre">-S</span> <span class="pre">yourfile.erl</span></code>. Each
instruction has 0 or more arguments. Different tricks are used to encode
arguments in a portable and compact way. For example locations in code (so called
labels) are encoded by their index, and code loader later translates them to
memory addresses.</p>
<p>During BEAM code loading, some combinations of opcodes are replaced with a
faster opcode. This is optimisation trick called <em>superinstruction</em>.
For each opcode, there is a piece of C code in <code class="docutils literal notranslate"><span class="pre">beam_emu.c</span></code> which has a
C label. An array of C labels is stored at the end of the same VM loop routine
and is used as the lookup table.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>BEAM Wisdoms: In depth: <a class="reference internal" href="indepth-beam-file.html"><span class="doc">BEAM File Format</span></a>.</p>
<p>BEAM Wisdoms: In depth: <a class="reference internal" href="indepth-beam-instructions.html"><span class="doc">BEAM Instruction Codes</span></a>.</p>
</div>
</section>
<section id="threaded-vm-loop">
<h2>Threaded VM Loop<a class="headerlink" href="#threaded-vm-loop" title="Permalink to this heading">¶</a></h2>
<p>VM emulator loop in <code class="docutils literal notranslate"><span class="pre">emulator/beam/beam_emu.s</span></code> contains a lot of small
pieces of code, each having a label and handling one BEAM instruction.
They all belong to one very long function.
A table of labels is stored in the same function which is used as lookup table.</p>
<p>After the loading opcodes are replaced with such label addresses, followed by
arguments. For example, for opcode #1, an element with index 1 from labels
array is placed in the code memory.</p>
<p>This way it is easy to jump to a location in C code which handles next opcode.
Just read a <code class="docutils literal notranslate"><span class="pre">void*</span></code> pointer and do a <code class="docutils literal notranslate"><span class="pre">goto</span> <span class="pre">*p</span></code>. This feature is an
extension to C and C++ compilers. This type of VM loop is called
<em>direct-threaded dispatch</em> virtual machine loop.</p>
<p>Other types of VM loops are:</p>
<ul class="simple">
<li><p><em>switch dispatch</em> VM (this one is used by BEAM VM source if the C compiler
refuses to support labels extension. It is also 20 to 30% slower than direct
threading;</p></li>
<li><p><em>direct call threading</em></p></li>
<li><p>and a few more exotic
<a class="reference external" href="http://www.cs.toronto.edu/~matz/dissertation/matzDissertation-latex2html/node6.html">http://www.cs.toronto.edu/~matz/dissertation/matzDissertation-latex2html/node6.html</a></p></li>
</ul>
</section>
</section>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-84125230-1', 'auto');
ga('send', 'pageview');
</script>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div style="margin-bottom:16px;">
    <a href="http://beam-wisdoms.clau.se/" alt="Wisdoms Home Page"
    title="Return to the Home Page"><img src="_static/img/bw_logo.png" width="200"></a>
</div>


<h1 class="logo"><a href="index.html">BEAM VM Wisdoms</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">BEAM VM ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-atoms.html">Atoms ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-processes.html">Processes ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-process-heap.html">Process Heaps ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-io.html">Input/Output and Ports ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-tracing.html">Tracing ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-bif-nif.html">BIF and NIF functions ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-types.html">Types ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-etf.html">External Term Format ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-property-based.html">Property Based Testing ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-efficiency.html">Efficiency ELI5</a></li>
<li class="toctree-l1"><a class="reference internal" href="eli5-efficiency-memory-perf.html">Memory Performance ELI5</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="definitions.html">BEAM Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-memory-layout.html">Data Types Memory Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-data-sizes.html">BEAM Internal data sizes</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-heap-layout.html">Process Heap Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="interfacing.html">Interfacing Erlang with the Outer World</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-beam-file.html">BEAM File Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-beam-instructions.html">BEAM Instruction Codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="indepth-io.html">IO in Erlang</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Welcome, adventurer!</a></li>
      <li>Next: <a href="eli5-atoms.html" title="next chapter">Atoms ELI5</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016-2023, Dmytro "kvakvs" Lytovchenko.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/eli5-vm.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>